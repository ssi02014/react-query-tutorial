# ğŸ’» Migrating to TanStack Query(React) v4

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-17 á„‹á…©á„’á…® 2 20 01](https://user-images.githubusercontent.com/64779472/185040681-2352e8c8-b2d7-40f7-893d-3ee2270904c9.png)

- TanStack Query(React Query v4)ê°€ ì •ì‹ ë¦´ë¦¬ì¦ˆë˜ë©´ì„œ v3ì™€ ë¹„êµí•´ì„œ ì£¼ìš” ë³€ê²½ì‚¬í•­ ì •ë¦¬ ë¬¸ì„œì…ë‹ˆë‹¤.
- [TanStack Query(React Query v4) ê³µì‹ ë¬¸ì„œ](https://tanstack.com/query/v4)
- [TanStack Query(React Query v4) migration ê³µì‹ ë¬¸ì„œ](https://tanstack.com/query/v4/docs/framework/react/guides/migrating-to-react-query-4)

<br />

## ğŸ“ƒ ì£¼ìš” ë³€ê²½ ì‚¬í•­

### @tanstack/react-query

- v4ë¶€í„° react-queryì—ì„œ `@tanstack/react-query`ë¡œ íŒ¨í‚¤ì§€ê°€ ë³€ê²½ë˜ì—ˆë‹¤. ë”°ë¼ì„œ ì„¤ì¹˜ì™€ import í•  ë•Œ ì£¼ì˜í•´ì•¼ í•œë‹¤.

```bash
$ npm i @tanstack/react-query
# or
$ pnpm add @tanstack/react-query
# or
$ yarn add @tanstack/react-query
```

- ë˜í•œ, DevtoolsëŠ” ë³„ë„ì˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤.

```bash
$ npm i @tanstack/react-query-devtools
# or
$ pnpm add @tanstack/react-query-devtools
# or
$ yarn add @tanstack/react-query-devtools
```

- import ì‹œ, ë‹¤ìŒê³¼ ê°™ì´ íŒ¨í‚¤ì§€ëª…ì„ ìˆ˜ì •í•˜ë©´ ëœë‹¤.

```diff
// v3
- import { useQuery } from "react-query";
- import { ReactQueryDevtools } from "react-query/devtools";

// v4
+ import { useQuery } from "@tanstack/react-query";
+ import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
```

<br />

### ì¿¼ë¦¬ í‚¤ëŠ” ë°°ì—´ë¡œ í†µì¼

- v3ì—ì„œëŠ” queryKeyë¥¼ ë¬¸ìì—´ ë˜ëŠ” ë°°ì—´ë¡œ ì§€ì •í•  ìˆ˜ ìˆì—ˆë‹¤. ë¬¸ìì—´ê³¼ ë°°ì—´ ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆëŠ”ë° ì‚¬ì‹¤ React QueryëŠ” ë‚´ë¶€ì ìœ¼ë¡œëŠ” í•­ìƒ Array Keysë¡œë§Œ ì‘ë™í–ˆì—ˆë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ v4ì—ì„œëŠ” ë°°ì—´ë¡œ í†µì¼ì‹œí‚¨ë‹¤.

```diff
// v3
- useQuery("todos", fetchTodos);

// v4
+ useQuery(["todos"], fetchTodos);
```

<br />

### status idle ìƒíƒœ ì œê±°

- v4ë¶€í„° ë” ë‚˜ì€ ì˜¤í”„ë¼ì¸ ì§€ì›ì„ ìœ„í•œ `fetchStatus`ê°€ ë„ì…ë˜ë©´ì„œ ê¸°ì¡´ì˜ `idle`ì´ ë¬´ì˜ë¯¸í•´ì¡ŒìŠµë‹ˆë‹¤.

```diff
// v3
- status: "idle";

// v4
+ status: "loading";
+ fetchStatus: "idle";
```

<br />

### fetchStatusê°€ ì¶”ê°€

- [FetchStatus](https://tanstack.com/query/v4/docs/guides/queries#why-two-different-states)
- TanStack Query(v4) ìƒˆë¡œìš´ ìƒíƒœê°’ì¸ `fetchStatus`ê°€ ì¶”ê°€ëë‹¤.
- fetchStatus
  - fetching: ì¿¼ë¦¬ê°€ í˜„ì¬ ì‹¤í–‰ì¤‘ì´ë‹¤.
  - paused: ì¿¼ë¦¬ë¥¼ ìš”ì²­í–ˆì§€ë§Œ, ì ì‹œ ì¤‘ë‹¨ëœ ìƒíƒœ
  - idle: ì¿¼ë¦¬ê°€ í˜„ì¬ ì•„ë¬´ ì‘ì—…ë„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ìˆë‹¤.

<br />

### ì™œ status, fetchStatus ë‚˜ëˆ ì„œ ë‹¤ë£¨ëŠ” ê±¸ê¹Œ?

- fetchStatusëŠ” HTTP ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœì™€ ì¢€ ë” ê´€ë ¨ëœ ìƒíƒœ ë°ì´í„°ì´ë‹¤.
  - ì˜ˆë¥¼ ë“¤ì–´, statusê°€ `success` ìƒíƒœë¼ë©´ ì£¼ë¡œ fetchStatusëŠ” `idle` ìƒíƒœì§€ë§Œ, ë°±ê·¸ë¼ìš´ë“œì—ì„œ re-fetchê°€ ë°œìƒí•  ë•Œ `fetching` ìƒíƒœì¼ ìˆ˜ ìˆë‹¤.
  - statusê°€ ë³´í†µ `loading` ìƒíƒœì¼ ë•Œ fetchStatusëŠ” ì£¼ë¡œ `fetching`ë¥¼ ê°–ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš° `paused` ìƒíƒœë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.
- ì •ë¦¬í•˜ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.

  - statusëŠ” `data`ê°€ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœ
  - fetchStatusëŠ” ì¿¼ë¦¬ ì¦‰, `queryFn ìš”ì²­`ì´ ì§„í–‰ì¤‘ì¸ì§€ ì•„ë‹Œì§€ì— ëŒ€í•œ ìƒíƒœ

- [why-two-different-states](https://tanstack.com/query/v4/docs/react/guides/queries#why-two-different-states)

<br />

### useQueries

- v4ë¶€í„° `useQueries`ëŠ” ì¸ìë¡œ `queries` í”„ë¡œí¼í‹°ë¥¼ ê°€ì§„ ê°ì²´ë¥¼ ë„˜ê²¨ì¤„ ìˆ˜ ìˆë‹¤.
- `queries`ì˜ ê°’ì€ ì¿¼ë¦¬ ë°°ì—´ì¸ë° ì´ëŠ” v3ì—ì„œ useQueriesì—ê²Œ ë„˜ê²¨ì£¼ë˜ ì¿¼ë¦¬ ë°°ì—´ê³¼ ë™ì¼í•˜ë‹¤.

```js
// v3
useQueries([
  { queryKey1, queryFn1, options1 },
  { queryKey2, queryFn2, options2 },
]);

// v4
useQueries({
  queries: [
    { queryKey1, queryFn1, options1 },
    { queryKey2, queryFn2, options2 },
  ],
});
```

<br />

### networkMode

- ê¸°ë³¸ì ìœ¼ë¡œ react-queryëŠ” promiseë¥¼ ë°˜í™˜í•˜ëŠ” ëª¨ë“  ê²ƒì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë©°, ì´ëŠ” axiosì™€ ê°™ì€ data fetching ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ì–´ì§„ë‹¤.
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ queryì™€ mutationì´ ì¼ì‹œì¤‘ì§€ ëœë‹¤. ì´ë•Œ, ì´ì „ ë™ì‘ì„ ì‹¤í–‰í•˜ë ¤ë©´ `networkMode`ë¥¼ ì„¤ì •í•´ì£¼ë©´ ëœë‹¤.

```js
new QueryClient({
  defaultOptions: {
    queries: {
      networkMode: "offlineFirst", // (+)
    },
    mutations: {
      networkmode: "offlineFirst", // (+)
    },
  },
});
```

- networkModeì˜ ì„¤ì •ê°’ì€ 3ê°€ì§€ê°€ ìˆë‹¤.
  - online: ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œ network ì—°ê²°ì´ ìˆê¸° ì „ê¹Œì§€ fetchë¥¼ í•˜ì§€ ì•Šê³ , ì´ë•Œ ì¿¼ë¦¬ì˜ ìƒíƒœë¥¼ `fetchStatus:paused`ë¡œ í‘œì‹œí•œë‹¤.
  - always: ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œë„ ì˜¨ë¼ì¸ì²˜ëŸ¼ fetchë¥¼ ì‹œë„í•©ë‹ˆë‹¤. ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²ƒì´ë‹ˆ `status:error` ìƒíƒœê°€ ëœë‹¤.
  - offlineFirst: `v3`ì—ì„œì˜ ë™ì‘ê³¼ ê°™ìŠµë‹ˆë‹¤. queryFn ìµœì´ˆ í˜¸ì¶œ í›„ retryë¥¼ ë©ˆì¶˜ë‹¤.

<br />

### Query Filters

- query filterëŠ” queryì™€ ì¼ì¹˜í•˜ëŠ” íŠ¹ì • ì¡°ê±´ì„ ê°€ì§„ ê°ì²´ë‹¤.
- ì§€ê¸ˆê¹Œì§€ í•„í„° ì˜µì…˜ì€ ëŒ€ë¶€ë¶„ boolean flag ì¡°í•©ì´ì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ëŸ¬í•œ flagë¥¼ ì¡°í•©í•˜ë©´ `ë¶ˆê°€ëŠ¥í•œ ìƒíƒœ`ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

```
active?: boolean
  - When set to true it will match active queries.
  - When set to false it will match inactive queries.
inactive?: boolean
  - When set to true it will match inactive queries.
  - When set to false it will match active queries.
```

- ì˜ˆë¥¼ ë“¤ì–´ ìœ„ì™€ ê°™ì€ `active`, `inactive` ë‘ ì˜µì…˜ì€ ì„œë¡œ `ìƒí˜¸ ë°°íƒ€ì `ì´ë‹¤. ì´ ë‘˜ ëª¨ë‘ë¥¼ falseìœ¼ë¡œ ì„¤ì •í•œë‹¤ë©´? ì´ëŠ” ë§ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤.
- v4ë¶€í„°ëŠ” ì´ë¥¼ typeì´ë¼ëŠ” ì†ì„±ìœ¼ë¡œ í†µì¼ì‹œì¼œì„œ ì˜ë„ë¥¼ ë” ì˜ ë³´ì—¬ì¤„ ìˆ˜ ìˆê²Œ ëë‹¤.

```diff
// v3
- active?: boolean
- inactive?: boolean

// v4
+ type?: 'active' | 'inactive' | 'all'
```

- type ì†ì„±ì€ ê¸°ë³¸ì ìœ¼ë¡œ `all`ë¡œ ì„¤ì •ë˜ë©°, active ë˜ëŠ” inactive ì¿¼ë¦¬ë§Œ ì¼ì¹˜í•˜ë„ë¡ ì„ íƒí•  ìˆ˜ ìˆë‹¤.

```js
// Cancel all queries
await queryClient.cancelQueries()
â€‹
// Remove all inactive queries that begin with `posts` in the key
queryClient.removeQueries({ queryKey: ['posts'], type: 'inactive' })
â€‹
// Refetch all active queries
await queryClient.refetchQueries({ type: 'active' })
â€‹
// Refetch all active queries that begin with `posts` in the key
await queryClient.refetchQueries({ queryKey: ['posts'], type: 'active' })
```

<br />

### React18 ì§€ì›

- v4ëŠ” `React18`ì—ëŒ€í•œ ìµœê³  ìˆ˜ì¤€ì˜ ì§€ì›ê³¼ í•¨ê»˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

<br />

### íƒ€ì…ìŠ¤í¬ë¦½íŠ¸

- [v4ëŠ” TypeScript `v4.1` ì´ìƒì„ ìš”êµ¬í•œë‹¤.](https://tanstack.com/query/v4/docs/react/guides/migrating-to-react-query-4#typescript)

<br />
